/**
 * The entry point for the client side of the explore-server.
 */
import * as React from "react";
import * as ReactDOM from "react-dom";
import CVEBenchmarkScoreTable from "./CVEBenchmarkScoreTable";
import * as CVEResults from "./CVEResults";
import * as Server from "./ServerFacade";
import pako from "pako";

import { compareToolIDs, getCve2tool2commitRuns } from "./util";
require("./style.css");

async function getData<T>(id: string): Promise<T> {
  let data = await (await fetch(`${id}.pako`)).arrayBuffer();
  return JSON.parse(
    pako.inflate(new Uint8Array(data), {
      to: "string"
    })
  );
}

(async function () {
  let server = new Server.StaticServer( // XXX hard-coded
    await getData("bcves"),
    await getData("bcvesWithRuns")
  );

  const urlParams = new URLSearchParams(window.location.search);

  let cve = urlParams.get("CVE");
  let content: JSX.Element;
  let toolIDs = (await server.getToolIds()).sort(compareToolIDs);
  if (cve) {
    let toolRuns = getCve2tool2commitRuns(await server.getAllToolRuns());
    let cwes = (await server.getCVE2CWEs())[cve];
    content = (
      <CVEResults.CVEResults
        CVE={cve}
        toolIDs={toolIDs}
        toolRuns={toolRuns[cve] || {}}
        CWEs={cwes}
        server={server}
      />
    );
  } else {
    let cves = await server.getCVEs();
    content = (
      <CVEBenchmarkScoreTable CVEs={cves} toolIDs={toolIDs} server={server} />
    );
  }
  ReactDOM.render(content, document.getElementById("main"));
})();
